---
version: '3.8'

networks:
  proxynet:
    name: proxynet
    external: true

services:
{%- for s in project.services %}
  {%- set p = project %}
  {{ project.name }}-{{ s.name }}:
  {%- if s.command %}
    command: {{ s.command }}
  {%- endif %}
  {%- if s.env %}
    environment:
    {%- for k, v in s.env %}
      {{ k }}: "{{ v }}"
    {%- endfor %}
  {%- endif %}
  {%- if p.entrypoint == s.name %}
    expose:
      - '{{ s.port }}/{{ Protocol[s.protocol].value }}'
  {%- endif %}
    image: {{ s.image }}
  {%- if p.entrypoint == s.name %}
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxynet
      - traefik.http.routers.{{ p.name }}.entrypoints=web-secure
      - traefik.http.routers.{{ p.name }}.rule=Host(`{{ p.domain }}`){%- if s.path_prefix %} && PathPrefix(`{{ s.path_prefix }}`){%- endif %}
      - traefik.http.routers.{{ p.name }}.tls.certresolver=letsencrypt
    {%- if path_prefix and path_remove %}
      - traefik.http.middlewares.removeServiceSelector.stripPrefix.prefixes={{ path_prefix }}
    {%- endif %}
      - traefik.http.services.{{ p.name }}.loadbalancer.server.port={{ s.port }}
    {%- for l in s.labels %}
      - {{ l }}
    {%- endfor %}    
  {%- endif %}
    networks:
  {%- if p.services | length > 1 %}
      - default
  {%- endif %}  
  {%- if p.entrypoint == s.name %}
      - proxynet
  {%- endif %}
    restart: {{ s.restart }}
  {%- if s.volumes %}
    volumes:
    {%- for v in s.volumes %}
      - .{{ v }}:{{ v }}
    {%- endfor %}
  {%- endif %}
  {%- for k, v in s.additional_properties.items() %}
    {{ k }}: {{ v }}
  {%- endfor %}
{%- endfor %}
