http:
  routers:
    http:
      service: noop@internal
      entryPoints:
        - web
      middlewares:
        - redirect
      rule: Host(`*`)
    traefik-secure:
      service: api@internal
      entryPoints:
        - web-secure
      middlewares:
        - traefik-auth
      rule: {{ traefik_rule }}
      tls:
        certResolver: letsencrypt
{%- for p in projects %}
  {%- set s = p.services[0] %}
  {%- if s.passthrough %}
    {{ p.name}}:
      service: {{ p.name }}
      entryPoints:
        - web
      rule: 'Host(`{{ p.domain }}`) && PathPrefix(`/.well-known/acme-challenge/`)'
  {%- endif %}
{%- endfor %}
  services:
{%- for p in projects %}
  {%- set s = p.services[0] %}
  {%- if s.passthrough %}
    {{ p.name}}:
      loadBalancer:
        servers:
          # just forwarding port 80 for doing own http challenge
          - url: http://{% if p.entrypoint == s.name %}{{ p.name }}-{% endif %}{{ s.name }}:80/
  {%- endif %}
{%- endfor %}
  middlewares:
    removeServiceSelector:
      stripPrefix:
        forceSlash: false
    redirect:
      redirectScheme:
        scheme: https
    traefik-auth:
      basicauth:
        users: {{ traefik_admin }}
