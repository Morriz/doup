http:
  routers:
    http:
      service: noop@internal
      entryPoints:
        - web
      middlewares:
        - redirect
      rule: Host(`*`)
    traefik-secure:
      service: api@internal
      entryPoints:
        - web-secure
      middlewares:
        - traefik-auth
      rule: {{ traefik_rule }}
      tls:
        certResolver: letsencrypt
{%- for p in projects %}
  {%- set s = p.services[0] %}
  {%- if s.passthrough or s.name != p.entrypoint %}
    {{ p.name}}:
      service: {{ p.name }}
      entryPoints:
    {%- if s.passthrough %}
        - web
      rule: 'Host(`{{ p.domain }}`) && PathPrefix(`/.well-known/acme-challenge/`)'
    {%- else %}
        - web-secure
      rule: 'Host(`{{ p.domain }}`)'
      tls:
        certResolver: letsencrypt
    {%- endif %}
  {%- endif %}
{%- endfor %}
  services:
{%- for p in projects %}
  {%- set s = p.services[0] %}
  {%- if s.passthrough or s.name != p.entrypoint %}
    {{ p.name}}:
      loadBalancer:
        servers:
    {%- if s.passthrough %}
          # just forwarding port 80 for doing own http challenge:
          - url: http://{{ s.name }}:80/
    {%- else %}
          # routing to a service on the host:
          - url: http://{{ s.name }}:{{ s.port }}/
    {%- endif %}
  {%- endif %}
{%- endfor %}
  middlewares:
    removeServiceSelector:
      stripPrefix:
        forceSlash: false
    redirect:
      redirectScheme:
        scheme: https
    traefik-auth:
      basicauth:
        users: {{ traefik_admin }}
